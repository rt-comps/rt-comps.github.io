let[compName,basePath]=rtlib.parseCompURL(import.meta.url);customElements.define(compName,class extends rtBC.RTBaseClass{#_sR;#_menu;#_details;#_form;#_cart;#_cartContents;constructor(){super(),this.#_sR=this.attachShadow({mode:"open"}),this.#_sR.append(this.$getTemplate());this.id="eventBus",this.#_form=this.#_sR.querySelector("form#user-form"),this.#_details=this.#_sR.querySelector("#product-details"),this.#_menu=this.#_sR.querySelector("#menu-items-container"),this.#_cart=this.#_sR.querySelector("#cart");var t=JSON.parse(localStorage.getItem("currentOrder"))||{},t=(this.#_cartContents=new Map(Object.entries(t)),{handleEvent:this.#detailsInitItemValues,orderNode:this}),t=(this.addEventListener("initdetails",t),this.#_menu.addEventListener("updatecountitem",t=>{t.stopPropagation(),this.#detailsButtonDisplay()}),this.#_cart.addEventListener("cartmod",t=>this.#orderModifyCurrent(t)),this.#_sR.querySelector("#product-details-close").addEventListener("click",t),{handleEvent:this.#detailsButtonClick,orderNode:this});this.#_sR.querySelector("#prod-add-but").addEventListener("click",t),this.#_sR.querySelector("#further-but").addEventListener("click",()=>this.#orderContinue()),this.#_sR.querySelector("#recover-but").addEventListener("click",()=>this.#orderRecover()),this.#_sR.querySelector("#submit-but").addEventListener("click",()=>this.#orderDispatch()),this.#_sR.querySelector("#cancel-but").addEventListener("click",()=>{this.#formShow(!1),this.#_sR.querySelector("div#cart").style.display="",this.#_form.reset()})}connectedCallback(){"undefined"!=typeof rtForm&&rtForm.getStyle(this,rtForm.findNode(this)),this.$dispatch({name:"formready"})}#cartButtonsDisplay(){var t,e,r=new Map([["further",this.#_sR.getElementById("further-but")],["last",this.#_sR.getElementById("recover-but")]]);for([t,e]of r)e.style.display="none";let i;var a=0===this.querySelectorAll("rt-lineitem").length;switch(!0){case a&&null!==localStorage.getItem("lastOrder"):i="last";break;case!a&&"none"===this.#_sR.querySelector("#form-container").style.display:i="further";break;default:i=null}i&&(r.get(i).style.display="")}#cartCurOrderUpdate(t){var e,r;if(t instanceof Map&&t.has("prodID")&&t.has("count"))return e=new Map([["updated",!1],["found",!1]]),r=t.get("prodID"),t=t.get("count"),0<this.#_cartContents.size&&this.#_cartContents.has(r)&&(e.set("found",!0),t!==this.#_cartContents.get(r))&&(0===t?this.#_cartContents.delete(r):this.#_cartContents.set(r,t),e.set("updated",!0)),!e.get("found")&&0<t&&(this.#_cartContents.set(r,t),e.set("updated",!0)),e.get("updated");console.error('#cartCurOrderUpdate() : "item" not in expected form')}#cartRebuild(){[...this.querySelectorAll("rt-lineitem")].forEach(t=>t.remove());let s=0;if(this.#_cartContents.size){let a=[];this.#_cartContents.forEach((t,e)=>{var r=this.querySelector(`rt-itemline[prodid="${e}"]`),i=r.parentElement,i=`${i.parentElement.querySelector("item-title").innerText}<br/>${i.getAttribute("value")} ${i.getAttribute("desc")}<br/>`+r.innerText,r=r.getAttribute("prijs");s+=parseInt(r)*t,a.push(this.$createElement({tag:"rt-lineitem",innerHTML:i,attrs:{slot:"cart",prodid:e,unit:r}}))}),this.append(...a)}this.#_sR.querySelector("#order-total-amount").innerHTML=this.$euro(s/100),this.#cartButtonsDisplay()}#cartToggle(){var t=this.#_cart.classList;t.contains("mini")?t.remove("mini"):t.add("mini")}#cartTotal(){let e=0;this.querySelectorAll("rt-lineitem").forEach(t=>{e+=parseInt(t.$attr("unit"))*parseInt(t.count)}),this.#_sR.querySelector("#order-total-amount").innerHTML=this.$euro(e/100)}#detailsButtonClick(t){t&&(t.stopPropagation(),"prod-add-but"!==(t=t.target).id||t.classList.contains("button-dis")||this.orderNode.#detailsUpdateCart())}#detailsButtonDisplay(){var t=getComputedStyle(this).getPropertyValue("--OF-HIDE-UPDATE"),e=this.shadowRoot.querySelector("#prod-add-but").classList;0<this.querySelectorAll("rt-itemdata[slot] rt-itemline[updated]").length?(e.remove("button-dis"),t&&e.remove("button-hide")):(e.add("button-dis"),t&&e.add("button-hide"))}#detailsInitItemValues(t){if(t instanceof Event){t.stopPropagation();let e=this.orderNode;e&&(t.detail.id?(t=t.detail.id,e.querySelectorAll("rt-itemdata").forEach(t=>t.removeAttribute("slot")),(t=e.querySelector("rt-itemdata#"+t)).setAttribute("slot","active-data"),t.querySelectorAll("rt-itemline").forEach(t=>{t.count=e.#_cartContents.has(t.$attr("prodid"))?e.#_cartContents.get(t.$attr("prodid")):0,t.render()}),e.#detailsButtonDisplay(),e.#_details.showModal()):e.#_details.close())}else this.#_details.close()}#detailsUpdateCart(){let e=new Map([["changed",!1]]);var t=this.querySelectorAll('[slot="active-data"] rt-itemline[updated]');0<t.length&&(t.forEach(t=>{this.#cartCurOrderUpdate(new Map([["prodID",t.$attr("prodid")],["count",parseInt(t.count)]]))&&!e.get("changed")&&e.set("changed",!0),t.removeAttribute("updated")}),e.get("changed"))&&(0<this.#_cartContents.size?localStorage.setItem("currentOrder",this.$map2JSON(this.#_cartContents)):localStorage.removeItem("currentOrder"),this.#cartRebuild()),this.#detailsInitItemValues()}#formShow(t){this.#_menu.querySelector("#menu").style.display=t?"none":"",this.#_menu.querySelector("#form-container").style.display=t?"":"none",this.#cartButtonsDisplay()}#formValidate(){var t,e=new Map([["failed",!1]]);if(this.#_form)for(t of this.#_form.querySelectorAll("rt-form-field[required], rt-pickup-locations")){var r=t.checkValidity();if(!r.get("valid")){r=r.get("field");t.focus(r),e.set("failed",!0),e.set("field",r);break}}return e}#orderContinue(){var t=localStorage.getItem("user-details");t&&(this.#_form.querySelector("#savefields").checked=!0,this.$JSON2map(t).forEach((t,e)=>this.#_form.querySelector(`[name=${e}]`).value=t)),this.#formShow(!0)}#orderDispatch(){var t=this.#formValidate();t.get("failed")?console.warn("Form submission not valid - "+t.get("field")):(t=new FormData(this.#_form),this.$dispatch({name:"neworder",detail:{person:Object.fromEntries(t.entries()),order:Object.fromEntries(this.#_cartContents)}}))}#orderInitialise(){var t=this.querySelector('div[slot="user-form"]');if(t){this.#_sR.querySelector("form#user-form").append(t);let i=this.querySelector("form-config span#imgpath").textContent;t=[...this.querySelectorAll("rt-itemdata")];if(this.append(...t.map(t=>{var e={id:"mi-"+t.id,slot:"menu-items"},r=t.querySelector("img");return r&&(e.bgimg=i+"/"+r.getAttribute("file")),this.$createElement({tag:"rt-menuitem",innerHTML:""+t.querySelector("item-title").innerHTML,attrs:e})})),window.matchMedia("(max-width: 430px)").matches){let e=this.#_cart.querySelector("#cart-title");e.addEventListener("click",()=>this.#cartToggle()),setTimeout(()=>{var t=getComputedStyle(this.#_cart),t=2*parseInt(t.paddingTop)+2*parseInt(t.borderLeftWidth),t=(parseFloat(e.getBoundingClientRect().height)+t).toFixed(0)+"px";this.#_cart.style.setProperty("--MINIMIZED-CART",t),this.#_cart.classList.remove("init")},200)}this.#_sR.querySelector("#product-details-close img").src=`${basePath}/components/${compName}/img/close-blk.png`,this.#_menu.querySelector("#menu").style.display="",this.#cartRebuild()}else console.error("User details form is missing!!"),this.#_sR.querySelector("#menu-items-container").append(document.createRange().createContextualFragment('<h1 style="color: red;">User details form is missing from data file!!</h1>'))}#orderModifyCurrent(t){t.stopPropagation(),this.#cartCurOrderUpdate(new Map([["prodID",t.detail.prodID],["count",t.detail.count]])),0<this.#_cartContents.size?localStorage.setItem("currentOrder",this.$map2JSON(this.#_cartContents)):localStorage.removeItem("currentOrder"),this.#cartTotal()}#orderRecover(){localStorage.getItem("lastOrder")&&localStorage.setItem("currentOrder",localStorage.getItem("lastOrder")),this.#_cartContents=this.$JSON2map(localStorage.getItem("currentOrder")),this.#cartRebuild()}get cartContents(){return this.#_cartContents}accepted(){localStorage.setItem("lastOrder",localStorage.getItem("currentOrder")),localStorage.removeItem("currentOrder"),this.#_cartContents.clear(),this.#cartRebuild();var t=this.#_sR.querySelector("#savefields");t&&t.checked?(t=[...this.#_sR.querySelectorAll("#formfields :is(rt-form-field, textarea)")].reduce((t,e)=>t.set(e.name,e.value),new Map),localStorage.setItem("user-details",this.$map2JSON(t))):localStorage.removeItem("user-details"),this.#_form.reset(),this.#formShow(!1),console.log("Form Submitted!")}async loadMenu(r){try{if(void 0===r)throw new Error("No Datafile",{cause:"nofile"});var t=await fetch(r);if(!t.ok)throw new Error("Datafile URL is not valid",{cause:"invalid"});var e=await t.text(),i=document.createRange().createContextualFragment(e);this.appendChild(i),this.#orderInitialise()}catch(t){console.error(t);let e;switch(t.cause){case"nofile":e='<h1 style="color: red;">Datafile URL not provided</h1>';break;case"invalid":e='<h1 style="color: red;">Datafile URL is not valid</h1>'}r=document.createRange().createContextualFragment(e);this.#_sR.querySelector("#menu-items-container").appendChild(r)}this.style.display="inline-block"}});